<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Video Downloader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, Arial; padding: 2rem; max-width: 800px; margin: auto; }
    input, button, select { padding: .6rem; font-size: 1rem; margin-bottom: .5rem; }
    #status { margin-top: 1rem; font-weight: bold; }
    .hint { color: #555; font-size: .9rem; margin-top: .25rem; }
    .error { color: #b00020; }
    .success { color: #0a7d00; }
    .form-row { display: flex; gap: 0.5rem; align-items: flex-start; flex-wrap: wrap; }
    .form-row > * { flex: 1; min-width: 200px; }
    .quality-select { flex: 0 0 120px; }
    .download-btn { flex: 0 0 100px; }
  </style>
</head>
<body>
  <h1>Video Downloader</h1>
  <p>Paste a YouTube URL you own or have permission to download.</p>

  <div class="form-row">
    <input
      id="url"
      placeholder="https://youtu.be/VIDEO_ID or https://www.youtube.com/watch?v=VIDEO_ID"
      pattern="(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.*"
      title="Enter a valid YouTube URL (youtube.com or youtu.be)"
      required
    />
    <select id="quality" class="quality-select" title="Video quality">
      <option value="144p">144p</option>
      <option value="240p">240p</option>
      <option value="360p">360p</option>
      <option value="480p">480p</option>
      <option value="720p" selected>720p</option>
      <option value="1080p">1080p</option>
      <option value="best">Best</option>
    </select>
    <button id="download" class="download-btn">Download</button>
  </div>
  
  <div class="hint">Only YouTube URLs are supported. Choose your preferred quality.</div>
  <p id="status"></p>

  <script>
    // Try Railway first (working), then Render as fallback
    const BACKENDS = [
      'https://vd-backend-production.up.railway.app',
      'https://vd-backend-f1vo.onrender.com'
    ];
    const API_KEY = (window.__API_KEY__ || 'testing123');

    function joinUrl(base, path) {
      if (!base) return path;
      return base.replace(/\/$/, '') + '/' + path.replace(/^\//, '');
    }

    function getStatusEl() {
      return document.getElementById('status');
    }

    function isYouTubeUrl(u) {
      try {
        const parsed = new URL(u);
        const host = parsed.hostname.toLowerCase();
        return ['youtube.com', 'www.youtube.com', 'm.youtube.com', 'youtu.be', 'music.youtube.com'].includes(host);
      } catch {
        return false;
      }
    }

    async function downloadVideo() {
      const urlInput = document.getElementById('url');
      const qualitySelect = document.getElementById('quality');
      const url = urlInput.value.trim();
      const quality = qualitySelect.value;
      const statusEl = getStatusEl();

      // Client-side validation
      if (!url) {
        urlInput.focus();
        statusEl.textContent = 'Please paste a YouTube URL.';
        statusEl.className = 'error';
        return;
      }
      if (!isYouTubeUrl(url)) {
        urlInput.focus();
        statusEl.textContent = 'Only YouTube URLs are supported (youtube.com or youtu.be).';
        statusEl.className = 'error';
        return;
      }

      statusEl.textContent = `Trying multiple servers (${quality})...`;
      statusEl.className = '';

      const params = new URLSearchParams({ url, quality });

      for (let i = 0; i < BACKENDS.length; i++) {
        try {
          statusEl.textContent = `Trying server ${i + 1}/${BACKENDS.length} (${quality})...`;
          const endpoint = joinUrl(BACKENDS[i], 'download') + `?${params.toString()}`;

          const res = await fetch(endpoint, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + API_KEY }
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({ detail: res.statusText }));
            throw new Error(err.detail || res.statusText || 'Download failed');
          }

          statusEl.textContent = `Success with server ${i + 1} (${quality})!`;
          statusEl.className = 'success';

          const disposition = res.headers.get('Content-Disposition') || 'video.mp4';
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = blobUrl;
          const match = /filename="?([^"]+)"?/.exec(disposition);
          a.download = match ? match[1] : `video_${quality}.mp4`;

          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(blobUrl);

          statusEl.textContent = `Download started (${quality})!`;
          return; // success
        } catch (e) {
          console.log(`Server ${i + 1} failed:`, e.message);
          // Try next server
        }
      }

      statusEl.textContent = `All servers failed. YouTube may be blocking this video or ${quality} is not available.`;
      statusEl.className = 'error';
    }

    document.getElementById('download').addEventListener('click', downloadVideo);
  </script>
</body>
</html>