<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Video Downloader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, Arial; padding: 2rem; max-width: 800px; margin: auto; }
    input, button { padding: .6rem; font-size: 1rem; margin-bottom: .5rem; }
    #status { margin-top: 1rem; font-weight: bold; }
    .hint { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>Video Downloader</h1>
  <p>Paste a YouTube / Facebook URL you own or have permission to download.</p>

  <input id="url" placeholder="https://youtu.be/VIDEO_ID or https://www.youtube.com/watch?v=VIDEO_ID" style="width:70%" pattern="(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.*" title="Enter a valid YouTube URL (youtube.com or youtu.be)" required />
  <div class="hint">Only YouTube URLs are supported.</div>
  <input id="title" placeholder="Optional filename" style="width:25%" />
  <br/>
  <button id="download">Download</button>
  <script>
    // Try multiple backend servers in order; stop on first success
    const BACKENDS = [
      'https://vd-backend-production.up.railway.app/',
      'https://vd-backend-f1vo.onrender.com',
      // Add more as you deploy them
    ];
    const API_KEY = (window.__API_KEY__ || 'testing123');

    function joinUrl(base, path) {
      if (!base) return path;
      return base.replace(/\/$/, '') + '/' + path.replace(/^\//, '');
    }

    // Ensure there's a status element to write to
    function getStatusEl() {
      let el = document.getElementById('status');
      if (!el) {
        el = document.createElement('p');
        el.id = 'status';
        document.body.appendChild(el);
      }
      return el;
    }

    async function downloadVideo() {
      const url = document.getElementById('url').value.trim();
      const title = document.getElementById('title').value.trim();
      if (!url) return alert('Paste a URL');

    const statusEl = getStatusEl();
      statusEl.innerText = 'Trying multiple servers...';

      const params = new URLSearchParams({ url });
      if (title) params.append('title', title);

      for (let i = 0; i < BACKENDS.length; i++) {
        try {
          statusEl.innerText = `Trying server ${i + 1}/${BACKENDS.length}...`;
          const endpoint = joinUrl(BACKENDS[i], 'download') + `?${params.toString()}`;
          const res = await fetch(endpoint, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + API_KEY },
          });

          if (!res.ok) {
            // Try to read JSON error but don't fail if not JSON
            const err = await res.json().catch(() => ({ detail: res.statusText }));
            throw new Error(err.detail || res.statusText || 'Download failed');
          }

          statusEl.innerText = `Success with server ${i + 1}!`;

          const disposition = res.headers.get('Content-Disposition') || 'video.mp4';
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = blobUrl;
          const match = /filename="?([^\"]+)"?/.exec(disposition);
          a.download = match ? match[1] : 'video.mp4';

          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(blobUrl);
          statusEl.innerText = 'Download started!';
          return; // success, stop trying more servers
        } catch (e) {
          console.log(`Server ${i + 1} failed:`, e.message);
          // continue to next server
        }
      }

      statusEl.innerText = 'All servers failed. YouTube may be blocking this video.';
    }

    document.getElementById('download').addEventListener('click', downloadVideo);
  </script>
  document.getElementById('download').addEventListener('click', downloadVideo);
</script>
</body>
</html>
